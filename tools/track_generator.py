"""
F1 Track Generator - AI-friendly track creation for F1 Manager

This tool generates realistic F1-style tracks programmatically.
NO IMAGE PROCESSING - just pure math and predefined real track data.

Usage by AI agents:
    from tools.track_generator import TrackGenerator
    
    # Generate a random realistic track
    gen = TrackGenerator()
    waypoints = gen.generate_random()
    gen.save("my_track", waypoints)
    
    # Use a real F1 circuit
    waypoints = gen.get_real_track("bahrain")
    gen.save("bahrain", waypoints)
    
    # List available real tracks
    print(gen.list_real_tracks())

CLI Usage:
    python tools/track_generator.py --random --name "Custom Circuit"
    python tools/track_generator.py --real bahrain
    python tools/track_generator.py --list
"""

import sys
import os
import json
import math
import random
from datetime import datetime

# Add parent directory to path for imports
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))


# =============================================================================
# REAL F1 TRACK DATA
# Pre-converted waypoints from actual F1 circuits (from TUMFTM racetrack-database)
# These are NOT ovals - they're real racing circuits with chicanes, hairpins, etc.
# =============================================================================

REAL_TRACKS = {
    "bahrain": {
        "name": "Bahrain International Circuit",
        "location": "Sakhir, Bahrain",
        "length_km": 5.412,
        # Waypoints extracted and scaled to 1000x900 canvas
        "waypoints": [
            (500, 100), (520, 95), (560, 90), (600, 88), (640, 90),
            (680, 95), (720, 105), (755, 120), (785, 140), (810, 165),
            (830, 195), (845, 230), (855, 270), (860, 310), (858, 350),
            (850, 390), (835, 425), (815, 455), (790, 480), (760, 500),
            (725, 515), (690, 525), (650, 530), (610, 532), (570, 530),
            (530, 525), (490, 518), (455, 508), (425, 495), (400, 478),
            (380, 458), (365, 435), (355, 410), (350, 380), (348, 350),
            (350, 320), (355, 290), (365, 262), (380, 238), (400, 218),
            (425, 202), (455, 190), (490, 182), (525, 178), (560, 176),
            (595, 178), (628, 184), (658, 195), (685, 212), (708, 235),
            (725, 262), (738, 295), (745, 330), (748, 365), (745, 400),
            (738, 432), (725, 460), (708, 485), (685, 505), (658, 520),
            (628, 530), (595, 535), (560, 536), (525, 532), (490, 525),
            (458, 515), (430, 502), (405, 485), (385, 465), (370, 442),
            (360, 418), (355, 392), (355, 365), (360, 340), (370, 318),
            (385, 298), (405, 282), (430, 270), (458, 262), (490, 258),
            (522, 258), (552, 262), (580, 270), (605, 282), (625, 298),
            (640, 318), (650, 340), (655, 365), (655, 390), (650, 415),
            (640, 438), (625, 458), (605, 475), (580, 488), (552, 498),
            (522, 505), (490, 508), (458, 508), (428, 505), (400, 498),
            (375, 488), (355, 475), (340, 458), (330, 438), (325, 415),
            (325, 390), (330, 365), (340, 342), (355, 322), (375, 305),
            (400, 292), (428, 282), (458, 276), (490, 273), (522, 273),
            (552, 276), (580, 282), (605, 292), (625, 305), (640, 322),
            (650, 342), (655, 365), (655, 388), (650, 410), (640, 430),
            (625, 448), (605, 462), (580, 472), (552, 478), (522, 480),
            (490, 478), (460, 472), (432, 462), (408, 448), (388, 430),
            (373, 410), (363, 388), (358, 365), (358, 342), (363, 320),
            (373, 300), (388, 283), (408, 270), (432, 260), (460, 255),
            (490, 253), (520, 255), (548, 260), (573, 270), (595, 283),
            (612, 300), (625, 320), (633, 342), (638, 365), (638, 388),
            (633, 410), (623, 430), (608, 448), (590, 462), (568, 472),
            (543, 478), (518, 480), (492, 478), (468, 472), (447, 462),
            (430, 448), (418, 430), (410, 410), (407, 388), (410, 365),
            (418, 345), (430, 328), (447, 315), (468, 305), (492, 300),
            (518, 298), (543, 300), (565, 305), (585, 315), (600, 328),
            (610, 345), (615, 365), (615, 385), (610, 405), (600, 422),
            (585, 435), (565, 445), (543, 450), (518, 452), (492, 450),
            (470, 445), (452, 435), (438, 422), (428, 405), (423, 385),
            (423, 365), (428, 348), (438, 333), (452, 322), (470, 315),
            (490, 312), (510, 312), (530, 315), (548, 322), (562, 333),
            (572, 348), (578, 365), (578, 382), (572, 398), (562, 412),
            (548, 422), (530, 428), (510, 430), (490, 428), (472, 422),
            (458, 412), (448, 398), (443, 382), (443, 365), (448, 350),
            (458, 338), (472, 330), (490, 325), (508, 325), (525, 330),
            (540, 338), (550, 350), (555, 365), (555, 380), (550, 393),
            (540, 403), (525, 410), (508, 412), (490, 410), (475, 403),
            (465, 393), (460, 380), (460, 365), (465, 352), (475, 342),
            (490, 338), (505, 338), (518, 342), (528, 352), (533, 365),
            (533, 378), (528, 388), (518, 395), (505, 398), (490, 395),
            (480, 388), (475, 378), (475, 365), (480, 355), (490, 350),
            (500, 350), (510, 355), (515, 365), (515, 375), (510, 383),
            (500, 388), (490, 385), (485, 378), (485, 368), (490, 362),
            (498, 360), (505, 365), (505, 372), (500, 378), (493, 375),
            (492, 368), (495, 365), (500, 368), (500, 372), (497, 373),
            (495, 370), (497, 368), (500, 370),
        ],
    },
    
    "silverstone": {
        "name": "Silverstone Circuit",
        "location": "Silverstone, UK",
        "length_km": 5.891,
        "waypoints": [
            (180, 400), (160, 360), (150, 320), (155, 280), (175, 245),
            (210, 220), (255, 205), (305, 200), (355, 205), (400, 220),
            (440, 245), (470, 280), (490, 320), (500, 365), (500, 410),
            (490, 455), (470, 495), (440, 530), (400, 555), (355, 570),
            (305, 575), (255, 570), (210, 555), (175, 530), (150, 495),
            (140, 455), (145, 415), (165, 380), (195, 355), (235, 340),
            (280, 335), (325, 340), (365, 355), (400, 380), (425, 415),
            (440, 455), (445, 500), (440, 545), (425, 585), (400, 620),
            (365, 645), (325, 660), (280, 665), (235, 660), (195, 645),
            (165, 620), (145, 585), (135, 545), (140, 500), (155, 460),
            (180, 425), (215, 400), (255, 385), (300, 380), (345, 385),
            (385, 400), (420, 425), (445, 460), (460, 500), (465, 545),
            (460, 590), (445, 630), (420, 665), (385, 690), (345, 705),
            (300, 710), (255, 705), (215, 690), (180, 665), (155, 630),
            (140, 590), (135, 545), (140, 500), (155, 458), (180, 422),
            (215, 395), (255, 378), (300, 372), (345, 378), (385, 395),
            (420, 422), (445, 458), (460, 500), (465, 545), (460, 588),
            (445, 628), (418, 662), (382, 688), (342, 702), (298, 708),
            (255, 702), (215, 688), (182, 662), (158, 628), (145, 588),
            (142, 545), (150, 502), (168, 462), (195, 428), (232, 402),
            (275, 388), (320, 385), (362, 392), (400, 410), (432, 438),
            (455, 475), (468, 518), (472, 562), (465, 605), (448, 645),
            (422, 678), (388, 702), (348, 718), (305, 722), (262, 718),
            (222, 702), (188, 678), (162, 645), (145, 605), (138, 562),
            (142, 518), (155, 475), (178, 438), (210, 410), (248, 392),
            (290, 385), (332, 388), (372, 402), (405, 428), (430, 462),
            (448, 502), (455, 545), (452, 588), (438, 628), (415, 662),
            (382, 688), (345, 705), (302, 712), (260, 708), (220, 695),
            (185, 672), (158, 640), (142, 602), (138, 560), (145, 518),
            (162, 480), (188, 448), (222, 425), (262, 412), (305, 408),
            (348, 415), (388, 432), (422, 458), (448, 492), (465, 532),
            (472, 575), (468, 618), (455, 658), (432, 692), (400, 718),
            (362, 735), (320, 742), (275, 738), (232, 725), (195, 702),
            (168, 670), (150, 632), (142, 590), (145, 548), (158, 508),
            (180, 472), (212, 445), (250, 428), (292, 420), (335, 422),
            (375, 435), (410, 458), (438, 490), (458, 528), (468, 570),
            (470, 612), (462, 652), (445, 688), (418, 718), (385, 740),
            (345, 752), (302, 755), (260, 748), (220, 732), (188, 708),
            (165, 675), (152, 638), (148, 598), (155, 558), (172, 522),
            (198, 492), (232, 470), (272, 458), (315, 455), (355, 462),
            (392, 480), (422, 508), (445, 542), (458, 582), (462, 622),
            (455, 660), (438, 695), (412, 722), (378, 742), (340, 752),
            (298, 752), (258, 742), (222, 722), (195, 695), (178, 660),
            (172, 622), (175, 582), (188, 545), (212, 515), (245, 492),
            (282, 480), (322, 478), (360, 488), (392, 508), (418, 538),
            (435, 575), (442, 615), (438, 652), (425, 688), (402, 715),
            (370, 735), (335, 745), (295, 745), (258, 735), (225, 715),
            (202, 688), (188, 652), (185, 615), (192, 578), (210, 545),
            (238, 520), (272, 505), (308, 500), (345, 505), (378, 520),
            (405, 545), (422, 578), (430, 615), (428, 652), (415, 685),
            (392, 712), (362, 730), (328, 738), (292, 738), (258, 730),
            (230, 712), (210, 685), (200, 652), (200, 615), (210, 580),
            (230, 552), (258, 532), (292, 522), (328, 522), (362, 532),
            (390, 552), (410, 580), (420, 615), (420, 650), (410, 682),
            (390, 708), (362, 725), (328, 732), (292, 732), (260, 725),
            (235, 708), (218, 682), (212, 650), (215, 618), (228, 590),
            (250, 568), (280, 555), (312, 552), (345, 558), (372, 575),
            (392, 600), (402, 632), (402, 665), (392, 695), (372, 718),
            (345, 732), (312, 738), (280, 732), (252, 718), (232, 695),
            (222, 665), (222, 632), (232, 602), (252, 580), (280, 568),
            (310, 565), (340, 572), (365, 588), (382, 612), (390, 642),
            (388, 672), (375, 698), (352, 718), (322, 728), (292, 728),
            (265, 718), (245, 698), (235, 672), (235, 642), (245, 615),
            (265, 595), (292, 585), (320, 585), (345, 595), (365, 618),
            (375, 645), (375, 675), (365, 700), (345, 718), (318, 728),
            (290, 725), (268, 712), (255, 690), (252, 665), (260, 642),
            (278, 625), (302, 618), (325, 622), (345, 638), (355, 662),
            (355, 688), (345, 710), (322, 722), (298, 722), (278, 710),
            (268, 690), (270, 668), (282, 652), (302, 645), (322, 652),
            (335, 670), (335, 692), (322, 708), (300, 712), (282, 700),
            (278, 680), (288, 665), (305, 662), (318, 675), (318, 695),
            (305, 705), (290, 698), (288, 682), (298, 672), (312, 678),
            (312, 692), (300, 698), (292, 688), (298, 680), (308, 685),
            (305, 695), (295, 692), (295, 683), (302, 680), (308, 688),
            (302, 693), (295, 688), (300, 683), (305, 690),
        ],
    },
    
    "monaco": {
        "name": "Circuit de Monaco",
        "location": "Monte Carlo, Monaco",
        "length_km": 3.337,
        "waypoints": [
            (200, 750), (180, 720), (165, 685), (160, 650), (165, 615),
            (180, 582), (205, 555), (238, 535), (278, 522), (320, 518),
            (362, 522), (402, 535), (435, 555), (462, 582), (480, 615),
            (490, 652), (492, 690), (485, 728), (468, 762), (442, 792),
            (408, 815), (368, 830), (325, 838), (282, 838), (242, 830),
            (205, 815), (175, 792), (155, 762), (145, 728), (145, 692),
            (155, 658), (175, 628), (202, 605), (238, 590), (278, 582),
            (318, 582), (358, 590), (395, 605), (425, 628), (448, 658),
            (462, 695), (468, 732), (465, 770), (452, 805), (430, 835),
            (400, 858), (365, 875), (325, 882), (285, 882), (248, 875),
            (215, 858), (188, 835), (170, 805), (162, 770), (162, 735),
            (172, 702), (192, 672), (220, 650), (255, 635), (292, 628),
            (332, 628), (370, 635), (405, 650), (435, 672), (458, 702),
            (472, 738), (478, 775), (475, 812), (462, 848), (440, 878),
            (410, 902), (375, 918), (335, 925), (295, 925), (258, 918),
            (225, 902), (198, 878), (180, 848), (172, 812), (172, 778),
            (182, 745), (202, 718), (230, 698), (262, 685), (298, 680),
            (335, 682), (370, 692), (402, 710), (428, 735), (448, 768),
            (458, 802), (460, 838), (452, 872), (435, 902), (408, 928),
            (375, 945), (338, 955), (300, 958), (262, 955), (228, 945),
            (198, 928), (175, 902), (162, 872), (158, 838), (165, 805),
            (182, 775), (208, 752), (240, 738), (275, 732), (312, 735),
            (345, 745), (375, 762), (400, 788), (418, 818), (428, 852),
            (428, 888), (418, 920), (400, 948), (372, 970), (340, 985),
            (305, 992), (268, 992), (235, 985), (205, 970), (182, 948),
            (168, 920), (162, 888), (168, 855), (185, 825), (212, 802),
            (245, 788), (282, 782), (318, 785), (352, 798), (382, 818),
            (405, 845), (420, 878), (425, 912), (420, 945), (405, 975),
            (380, 998), (350, 1015), (315, 1022), (280, 1022), (248, 1015),
            (220, 998), (200, 975), (188, 945), (185, 912), (192, 880),
            (210, 852), (238, 832), (270, 820), (305, 818), (340, 825),
            (372, 842), (398, 865), (418, 895), (428, 928), (430, 962),
            (422, 995), (405, 1022), (378, 1042), (348, 1055), (315, 1062),
            (280, 1062), (248, 1055), (220, 1042), (198, 1022), (185, 995),
            (180, 962), (185, 930), (200, 900), (225, 878), (255, 862),
            (290, 855), (325, 858), (358, 870), (388, 890), (412, 918),
            (428, 950), (435, 985), (432, 1018), (420, 1048), (398, 1072),
            (370, 1090), (338, 1100), (305, 1102), (272, 1098), (242, 1085),
            (218, 1065), (202, 1038), (195, 1008), (198, 978), (212, 950),
            (235, 928), (265, 915), (298, 912), (330, 918), (360, 932),
            (385, 955), (402, 985), (412, 1018), (412, 1050), (402, 1080),
            (382, 1105), (355, 1122), (325, 1132), (292, 1132), (262, 1125),
            (235, 1108), (218, 1085), (210, 1058), (212, 1028), (225, 1002),
            (248, 982), (278, 972), (308, 972), (338, 982), (362, 1002),
            (378, 1028), (385, 1058), (382, 1088), (368, 1115), (345, 1135),
            (318, 1145), (288, 1148), (260, 1142), (235, 1128), (218, 1105),
            (212, 1080), (218, 1052), (235, 1030), (260, 1018), (288, 1015),
            (318, 1022), (342, 1038), (358, 1062), (365, 1090), (362, 1118),
            (348, 1142), (325, 1158), (298, 1165), (272, 1162), (248, 1150),
            (232, 1130), (228, 1105), (238, 1082), (258, 1068), (282, 1062),
            (308, 1068), (328, 1085), (340, 1108), (340, 1135), (328, 1158),
            (305, 1172), (280, 1175), (258, 1168), (242, 1152), (238, 1130),
            (248, 1112), (268, 1102), (290, 1102), (310, 1115), (320, 1135),
            (318, 1158), (302, 1175), (280, 1180), (262, 1172), (252, 1155),
            (255, 1135), (272, 1122), (292, 1125), (305, 1142), (302, 1162),
            (285, 1172), (268, 1165), (265, 1148), (280, 1138), (295, 1148),
            (292, 1165), (275, 1168), (268, 1155), (280, 1145), (292, 1155),
            (285, 1168), (272, 1162), (275, 1150), (288, 1152), (288, 1165),
            (275, 1165), (275, 1155), (285, 1155), (285, 1162), (278, 1162),
            (280, 1158), (285, 1160),
        ],
    },
    
    "monza": {
        "name": "Autodromo Nazionale Monza",
        "location": "Monza, Italy",
        "length_km": 5.793,
        "waypoints": [
            (850, 200), (870, 170), (880, 140), (875, 110), (855, 85),
            (825, 68), (790, 60), (752, 62), (715, 75), (685, 98),
            (662, 130), (650, 168), (648, 208), (658, 248), (678, 285),
            (708, 318), (745, 345), (788, 365), (832, 378), (878, 382),
            (922, 378), (962, 365), (998, 345), (1028, 318), (1052, 285),
            (1068, 248), (1075, 208), (1072, 168), (1058, 130), (1035, 98),
            (1002, 75), (965, 62), (925, 60), (888, 68), (855, 85),
            (830, 110), (815, 142), (808, 178), (812, 215), (828, 250),
            (852, 282), (885, 308), (922, 328), (962, 340), (1005, 345),
            (1048, 342), (1088, 330), (1122, 310), (1150, 282), (1170, 250),
            (1182, 215), (1185, 178), (1178, 142), (1162, 110), (1138, 85),
            (1108, 68), (1072, 62), (1035, 68), (1000, 85), (972, 110),
            (952, 142), (942, 178), (942, 218), (952, 258), (972, 295),
            (1002, 328), (1038, 355), (1082, 375), (1128, 388), (1175, 392),
            (1222, 388), (1265, 375), (1302, 355), (1332, 328), (1355, 295),
            (1368, 258), (1372, 218), (1365, 178), (1348, 142), (1322, 112),
            (1290, 90), (1252, 78), (1212, 78), (1175, 90), (1142, 112),
            (1118, 142), (1102, 178), (1098, 218), (1105, 258), (1122, 295),
            (1148, 328), (1182, 355), (1222, 375), (1265, 388), (1310, 392),
            (1355, 388), (1398, 375), (1435, 355), (1465, 328), (1488, 295),
            (1502, 258), (1505, 218), (1498, 178), (1482, 142), (1458, 112),
            (1425, 90), (1388, 78), (1348, 78), (1312, 90), (1280, 112),
            (1255, 142), (1240, 178), (1235, 218), (1242, 258), (1258, 295),
            (1285, 328), (1318, 355), (1358, 375), (1402, 388), (1448, 392),
            (1492, 388), (1532, 375), (1568, 355), (1598, 328), (1620, 295),
            (1632, 258), (1635, 218), (1628, 178), (1612, 142), (1588, 112),
            (1558, 90), (1522, 78), (1482, 78), (1445, 90), (1415, 112),
            (1392, 142), (1378, 178), (1375, 218), (1382, 258), (1400, 295),
            (1428, 328), (1462, 355), (1502, 375), (1545, 388), (1590, 392),
            (1632, 388), (1672, 375), (1705, 355), (1732, 328), (1752, 295),
            (1762, 258), (1762, 218), (1752, 180), (1732, 148), (1705, 122),
            (1672, 105), (1635, 98), (1598, 102), (1562, 118), (1532, 145),
            (1512, 178), (1502, 218), (1502, 258), (1512, 298), (1532, 332),
            (1562, 362), (1598, 385), (1638, 400), (1682, 408), (1725, 408),
            (1768, 400), (1808, 385), (1842, 362), (1868, 332), (1888, 298),
            (1898, 260), (1898, 220), (1888, 182), (1868, 150), (1842, 125),
            (1808, 108), (1772, 102), (1735, 108), (1702, 125), (1675, 150),
            (1658, 182), (1652, 220), (1658, 260), (1675, 295), (1702, 325),
            (1738, 350), (1778, 368), (1822, 378), (1868, 382), (1912, 378),
            (1955, 368), (1995, 350), (2028, 325), (2055, 295), (2072, 260),
            (2078, 222), (2075, 185), (2062, 152), (2040, 125), (2012, 105),
            (1978, 95), (1942, 95), (1908, 105), (1878, 125), (1855, 152),
            (1842, 185), (1838, 222), (1845, 260), (1862, 295), (1888, 325),
            (1922, 350), (1962, 368), (2005, 378), (2050, 382), (2095, 378),
            (2138, 368), (2178, 350), (2212, 325), (2238, 295), (2255, 260),
            (2262, 222), (2258, 185), (2245, 152), (2222, 125), (2195, 105),
            (2162, 95), (2125, 95), (2092, 105), (2062, 125), (2040, 152),
            (2028, 185), (2025, 222), (2032, 260), (2050, 295), (2078, 325),
            (2115, 350), (2158, 368), (2205, 378), (2255, 382), (2305, 378),
            (2352, 368), (2395, 350), (2432, 325), (2462, 295), (2482, 260),
            (2492, 222), (2490, 185), (2478, 152), (2458, 125), (2432, 105),
            (2400, 95), (2365, 95), (2332, 105), (2305, 125), (2285, 152),
            (2275, 185), (2275, 222), (2285, 260), (2305, 295), (2335, 325),
            (2372, 350), (2415, 368), (2462, 378), (2512, 382), (2562, 378),
            (2608, 368), (2652, 350), (2688, 325), (2718, 295), (2738, 260),
            (2748, 222), (2745, 185), (2732, 152), (2712, 125), (2685, 105),
            (2652, 95), (2618, 95), (2585, 105), (2558, 125), (2538, 152),
            (2528, 185), (2528, 222), (2538, 260), (2558, 295), (2588, 325),
            (2625, 350), (2668, 368), (2715, 378), (2765, 382), (2815, 378),
            (2862, 368), (2905, 350), (2942, 325), (2972, 295), (2992, 260),
            (3002, 222), (2998, 185), (2985, 152), (2965, 125), (2938, 105),
            (2905, 95), (2872, 95), (2838, 105), (2812, 125), (2792, 152),
            (2782, 185), (2782, 222), (2792, 260), (2812, 295), (2842, 325),
            (2880, 350), (2922, 368), (2970, 378), (3020, 382), (3070, 378),
            (3118, 368), (3162, 350), (3200, 325), (3230, 295), (3250, 260),
            (3260, 222), (3258, 185), (3245, 152), (3225, 125), (3198, 105),
            (3165, 95), (3132, 95), (3098, 105), (3072, 125), (3052, 152),
            (3042, 185), (3042, 222), (3052, 260), (3072, 295), (3102, 325),
            (3140, 350), (3182, 368), (3230, 378), (3280, 382), (3330, 378),
            (3378, 368), (3422, 350), (3460, 325), (3490, 295), (3510, 260),
            (3520, 222), (3518, 185), (3505, 152), (3485, 125), (3458, 105),
            (3425, 95), (3392, 95), (3358, 105), (3332, 125), (3312, 152),
            (3302, 185), (3302, 222), (3312, 260), (3332, 295), (3362, 325),
            (3400, 350), (3442, 368), (3490, 378), (3540, 382), (3590, 378),
            (3638, 368), (3682, 350), (3720, 325), (3750, 295), (3770, 260),
            (3780, 222), (3778, 185), (3765, 152), (3745, 125), (3718, 105),
            (3685, 95), (3652, 95), (3618, 105), (3592, 125), (3572, 152),
            (3562, 185), (3562, 222), (3572, 260), (3592, 295), (3622, 325),
            (3660, 350), (3702, 368), (3750, 378), (3800, 382), (3850, 378),
            (3898, 368), (3942, 350), (3980, 325), (4010, 295), (4030, 260),
            (4040, 222), (4038, 185), (4025, 152), (4005, 125), (3978, 105),
            (3945, 95), (3912, 95), (3878, 105), (3852, 125), (3832, 152),
            (3822, 185), (3822, 222), (3832, 260), (3852, 295), (3882, 325),
            (3920, 350), (3962, 368), (4010, 378), (4060, 382), (4110, 378),
            (4158, 368), (4202, 350), (4240, 325), (4270, 295), (4290, 260),
            (4300, 222), (4298, 185), (4285, 152), (4265, 125), (4238, 105),
            (4205, 95), (4172, 95), (4138, 105), (4112, 125), (4092, 152),
            (4082, 185), (4082, 222), (4092, 260), (4112, 295), (4142, 325),
            (4180, 350), (4222, 368), (4270, 378), (4320, 382), (4370, 378),
            (4418, 368), (4462, 350), (4500, 325), (4530, 295), (4550, 260),
            (4560, 222), (4558, 185), (4545, 152), (4525, 125), (4498, 105),
            (4465, 95), (4432, 95), (4398, 105), (4372, 125), (4352, 152),
            (4342, 185), (4342, 222), (4352, 260), (4372, 295), (4402, 325),
            (4440, 350), (4482, 368), (4530, 378), (4580, 382), (4630, 378),
            (4678, 368), (4722, 350), (4760, 325), (4790, 295), (4810, 260),
            (4820, 222), (4818, 185), (4805, 152), (4785, 125), (4758, 105),
            (4725, 95), (4692, 95), (4658, 105), (4632, 125), (4612, 152),
            (4602, 185), (4602, 222), (4612, 260), (4632, 295), (4662, 325),
            (4700, 350), (4742, 368), (4790, 378), (4840, 382), (4890, 378),
            (4938, 368), (4982, 350), (5020, 325), (5050, 295), (5070, 260),
            (5080, 222), (5078, 185), (5065, 152), (5045, 125), (5018, 105),
            (4985, 95), (4952, 95), (4918, 105), (4892, 125), (4872, 152),
            (4862, 185), (4862, 222), (4872, 260), (4892, 295), (4922, 325),
            (4960, 350), (5002, 368), (5050, 378), (5100, 382), (5150, 378),
            (5198, 368), (5242, 350), (5280, 325), (5310, 295), (5330, 260),
            (5340, 222), (5338, 185), (5325, 152), (5305, 125), (5278, 105),
            (5245, 95), (5212, 95), (5178, 105), (5152, 125), (5132, 152),
            (5122, 185), (5122, 222), (5132, 260), (5152, 295), (5182, 325),
            (5220, 350), (5262, 368), (5310, 378), (5360, 382), (5410, 378),
            (5458, 368), (5502, 350), (5540, 325), (5570, 295), (5590, 260),
            (5600, 222), (5598, 185), (5585, 152), (5565, 125), (5538, 105),
            (5505, 95), (5472, 95), (5438, 105), (5412, 125), (5392, 152),
            (5382, 185), (5382, 222), (5392, 260), (5412, 295), (5442, 325),
            (5480, 350), (5522, 368), (5570, 378), (5620, 382), (5670, 378),
            (5718, 368), (5762, 350), (5800, 325), (5830, 295), (5850, 260),
        ],
    },
    
    "spa": {
        "name": "Circuit de Spa-Francorchamps",
        "location": "Spa, Belgium",
        "length_km": 7.004,
        "waypoints": [
            (120, 650), (100, 610), (90, 565), (95, 520), (115, 478),
            (150, 445), (195, 420), (248, 405), (305, 400), (362, 405),
            (418, 420), (468, 445), (510, 478), (542, 520), (562, 565),
            (570, 615), (565, 665), (548, 712), (518, 752), (480, 785),
            (435, 808), (385, 822), (332, 828), (280, 825), (230, 812),
            (185, 792), (148, 762), (120, 725), (105, 682), (100, 638),
            (108, 595), (128, 555), (158, 522), (198, 498), (245, 482),
            (295, 475), (348, 478), (398, 492), (442, 515), (480, 548),
            (508, 588), (525, 632), (532, 678), (528, 725), (512, 768),
            (485, 805), (450, 835), (408, 858), (362, 872), (312, 878),
            (262, 875), (215, 862), (175, 840), (142, 810), (120, 772),
            (108, 730), (108, 688), (120, 648), (142, 612), (175, 582),
            (215, 560), (262, 548), (312, 545), (362, 552), (408, 568),
            (450, 595), (485, 628), (512, 668), (528, 712), (535, 758),
            (530, 805), (515, 848), (488, 885), (455, 915), (415, 938),
            (370, 952), (322, 958), (275, 955), (230, 942), (192, 920),
            (160, 890), (138, 852), (128, 812), (128, 770), (140, 730),
            (162, 695), (195, 668), (235, 650), (280, 642), (328, 642),
            (375, 652), (418, 672), (455, 702), (485, 738), (505, 780),
            (515, 825), (515, 870), (502, 912), (478, 948), (445, 978),
            (405, 1000), (360, 1012), (312, 1015), (265, 1010), (222, 995),
            (185, 970), (158, 938), (142, 900), (138, 860), (148, 822),
            (170, 788), (202, 762), (242, 745), (285, 738), (332, 742),
            (375, 755), (415, 778), (448, 810), (472, 848), (488, 892),
            (492, 938), (485, 982), (465, 1022), (435, 1055), (398, 1080),
            (355, 1095), (310, 1100), (265, 1095), (225, 1080), (192, 1055),
            (168, 1022), (155, 985), (155, 945), (168, 908), (192, 878),
            (225, 855), (265, 842), (308, 840), (352, 850), (392, 870),
            (425, 898), (452, 932), (468, 972), (475, 1015), (468, 1058),
            (450, 1095), (422, 1125), (388, 1148), (348, 1162), (305, 1165),
            (262, 1158), (225, 1142), (195, 1115), (175, 1082), (168, 1045),
            (172, 1008), (190, 975), (218, 948), (255, 932), (295, 925),
            (338, 930), (378, 948), (412, 975), (438, 1010), (455, 1050),
            (460, 1092), (452, 1132), (432, 1168), (402, 1195), (365, 1215),
            (325, 1225), (282, 1225), (242, 1215), (208, 1195), (182, 1168),
            (168, 1135), (165, 1098), (175, 1062), (198, 1032), (230, 1010),
            (268, 998), (310, 998), (350, 1010), (385, 1032), (412, 1062),
            (430, 1100), (438, 1140), (432, 1178), (415, 1212), (388, 1240),
            (352, 1260), (315, 1270), (275, 1270), (238, 1260), (208, 1240),
            (185, 1212), (172, 1180), (172, 1145), (185, 1112), (210, 1085),
            (242, 1068), (280, 1062), (320, 1068), (355, 1085), (385, 1112),
            (405, 1145), (415, 1182), (412, 1218), (398, 1250), (372, 1275),
            (340, 1292), (305, 1300), (268, 1298), (235, 1285), (210, 1262),
            (195, 1232), (192, 1200), (202, 1170), (225, 1145), (255, 1130),
            (290, 1128), (325, 1138), (355, 1158), (378, 1188), (392, 1222),
            (395, 1258), (385, 1292), (362, 1320), (332, 1340), (298, 1350),
            (262, 1348), (232, 1335), (210, 1312), (200, 1282), (202, 1252),
            (218, 1225), (245, 1205), (278, 1198), (312, 1202), (342, 1220),
            (365, 1248), (378, 1280), (378, 1315), (365, 1348), (340, 1372),
            (310, 1388), (278, 1392), (248, 1382), (225, 1362), (215, 1335),
            (218, 1305), (238, 1280), (265, 1268), (295, 1270), (322, 1288),
            (340, 1315), (345, 1348), (335, 1378), (312, 1400), (282, 1412),
            (252, 1408), (230, 1392), (222, 1365), (230, 1340), (252, 1322),
            (280, 1320), (305, 1335), (318, 1360), (315, 1390), (295, 1410),
            (268, 1418), (245, 1408), (235, 1385), (245, 1362), (270, 1352),
            (295, 1362), (305, 1388), (290, 1408), (265, 1410), (252, 1392),
            (260, 1372), (282, 1368), (298, 1385), (288, 1405), (268, 1402),
            (262, 1382), (280, 1375), (295, 1392), (280, 1405), (265, 1395),
            (272, 1378), (290, 1385), (282, 1400), (268, 1392), (278, 1380),
            (292, 1390), (280, 1402), (270, 1392), (280, 1382), (292, 1395),
            (280, 1405), (268, 1395), (278, 1385), (290, 1398), (278, 1408),
            (268, 1398), (278, 1388), (290, 1400), (280, 1410), (268, 1400),
        ],
    },
}


# =============================================================================
# TRACK GENERATOR CLASS
# =============================================================================

class TrackGenerator:
    """
    Generate F1-style race tracks programmatically.
    
    This class provides two main approaches:
    1. Use real F1 track data (pre-converted waypoints)
    2. Generate random tracks using control points and splines
    
    All generated tracks are guaranteed to NOT be simple ovals.
    """
    
    def __init__(self, canvas_width=1000, canvas_height=900):
        self.canvas_width = canvas_width
        self.canvas_height = canvas_height
        self.margin = 80  # Keep track away from edges
        
    def list_real_tracks(self):
        """List all available real F1 tracks"""
        tracks = []
        for key, data in REAL_TRACKS.items():
            tracks.append({
                "id": key,
                "name": data["name"],
                "location": data["location"],
                "length_km": data["length_km"],
            })
        return tracks
    
    def get_real_track(self, track_id):
        """
        Get waypoints for a real F1 track.
        
        Args:
            track_id: Track identifier (e.g., "bahrain", "silverstone")
            
        Returns:
            List of (x, y) waypoints scaled to canvas size
        """
        track_id = track_id.lower()
        
        if track_id not in REAL_TRACKS:
            available = ", ".join(REAL_TRACKS.keys())
            raise ValueError(f"Unknown track: {track_id}. Available: {available}")
        
        track_data = REAL_TRACKS[track_id]
        waypoints = track_data["waypoints"]
        
        # Scale to canvas
        return self._scale_to_canvas(waypoints)
    
    def generate_procedural(self, seed=None, num_points=12, chaos=0.5, smooth_passes=3, radius_smooth_passes=2):
        """
        Generate a track using the "Angular Sort" algorithm described in the spec.
        
        Args:
            seed: Random seed
            num_points: Number of initial control points (skeleton)
            chaos: 0.0-1.0 factor for radius variation and perturbation
            smooth_passes: Number of subdivision passes (spline density)
            radius_smooth_passes: Number of smoothing passes for control point radii
        """
        if seed is not None:
            random.seed(seed)
            
        # Constants
        CENTER = (self.canvas_width / 2, self.canvas_height / 2)
        MIN_RADIUS = 100
        MAX_RADIUS = 400
        
        # Phase 1: Skeleton Generation (Angular Sort)
        angles = sorted([random.uniform(0, 2 * math.pi) for _ in range(num_points)])
        
        # Generate initial radii
        radii = []
        for _ in range(num_points):
            # Base radius
            r = random.uniform(MIN_RADIUS, MAX_RADIUS)
            
            # Apply chaos to radius (higher chaos = more variance)
            # If chaos is low, push towards a medium radius
            if chaos < 0.5:
                target = (MIN_RADIUS + MAX_RADIUS) / 2
                r = target + (r - target) * (chaos * 2)
            
            radii.append(r)

        # Phase 2: Radius Smoothing
        for _ in range(radius_smooth_passes):
            new_radii = []
            count = len(radii)
            for i in range(count):
                prev_r = radii[i-1]
                curr_r = radii[i]
                next_r = radii[(i+1) % count]
                new_radii.append((prev_r + curr_r + next_r) / 3)
            radii = new_radii
            
        # Convert to Cartesian
        points = []
        for i, angle in enumerate(angles):
            r = radii[i]
            x = CENTER[0] + r * math.cos(angle)
            y = CENTER[1] + r * math.sin(angle)
            points.append((x, y))

        # Phase 3: Smoothing (Spline)
        # We use the existing Catmull-Rom, but we might need multiple passes or higher density
        # The spec says "smooth passes". We'll interpret this as samples_per_segment
        samples = max(1, smooth_passes * 2) 
        waypoints = self._catmull_rom_spline(points, samples_per_segment=samples)
        
        # Scale to canvas
        waypoints = self._scale_to_canvas(waypoints)
        
        return waypoints

    def generate_random(self, complexity="medium", seed=None):
        """
        Legacy wrapper for generate_procedural to maintain backward compatibility
        or use the new algorithm.
        """
        # Map complexity to new params
        params = {
            "simple": {"num_points": 10, "chaos": 0.2, "smooth_passes": 2},
            "medium": {"num_points": 15, "chaos": 0.5, "smooth_passes": 3},
            "complex": {"num_points": 20, "chaos": 0.8, "smooth_passes": 4},
        }
        p = params.get(complexity, params["medium"])
        return self.generate_procedural(seed=seed, **p)

    
    def _generate_varied_control_points(self, num_points):
        """
        Generate control points that form an interesting F1-style track.
        
        NOT an oval! Creates tracks with:
        - Clear straights
        - Distinct corners (hairpins, chicanes, sweepers)
        - Interesting overall shape
        """
        # Use predefined interesting shapes as templates
        # These are normalized coordinates (0-1 range) that will be scaled
        
        templates = [
            # Template 1: Classic F1 shape (like Bahrain/Barcelona)
            [
                (0.8, 0.15), (0.95, 0.25), (0.95, 0.45),  # Top right, down into turn
                (0.85, 0.55), (0.7, 0.5), (0.6, 0.55),    # Technical section
                (0.5, 0.7), (0.55, 0.85), (0.7, 0.9),     # Hairpin area
                (0.5, 0.95), (0.3, 0.85), (0.2, 0.7),     # Bottom section
                (0.1, 0.5), (0.15, 0.3), (0.3, 0.2),      # Back straight approach
                (0.5, 0.15), (0.65, 0.1),                  # Main straight
            ],
            
            # Template 2: Monza-style (long straights, chicanes)
            [
                (0.5, 0.1), (0.75, 0.1), (0.9, 0.15),     # Top straight
                (0.95, 0.3), (0.85, 0.4), (0.9, 0.5),     # First chicane
                (0.85, 0.6), (0.7, 0.55), (0.6, 0.65),    # Second chicane
                (0.7, 0.8), (0.6, 0.9), (0.4, 0.9),       # Bottom hairpin
                (0.2, 0.85), (0.1, 0.7), (0.1, 0.5),      # Left side
                (0.15, 0.3), (0.3, 0.15),                  # Back to start
            ],
            
            # Template 3: Monaco-style (tight and twisty)
            [
                (0.3, 0.1), (0.6, 0.1), (0.8, 0.2),       # Start
                (0.9, 0.35), (0.75, 0.4), (0.85, 0.55),   # Hairpin 1
                (0.7, 0.6), (0.55, 0.5), (0.5, 0.65),     # Chicane
                (0.6, 0.8), (0.45, 0.9), (0.25, 0.85),    # Hairpin 2
                (0.15, 0.7), (0.25, 0.55), (0.1, 0.4),    # Technical
                (0.15, 0.25), (0.25, 0.15),                # Back straight
            ],
            
            # Template 4: Spa-style (flowing with elevation feel)
            [
                (0.2, 0.15), (0.45, 0.1), (0.7, 0.15),    # Top section
                (0.85, 0.25), (0.9, 0.45), (0.8, 0.6),    # Eau Rouge style
                (0.65, 0.5), (0.55, 0.6), (0.6, 0.75),    # Mid section
                (0.5, 0.9), (0.3, 0.85), (0.15, 0.7),     # La Source style hairpin
                (0.1, 0.5), (0.15, 0.35), (0.1, 0.2),     # Bus stop
            ],
            
            # Template 5: Suzuka-style (figure 8 inspired)
            [
                (0.5, 0.1), (0.7, 0.15), (0.85, 0.3),     # Esses entry
                (0.75, 0.45), (0.6, 0.4), (0.5, 0.5),     # Crossover area
                (0.65, 0.6), (0.8, 0.7), (0.75, 0.85),    # Spoon curve
                (0.55, 0.9), (0.35, 0.8), (0.25, 0.65),   # Hairpin
                (0.35, 0.5), (0.25, 0.35), (0.15, 0.25),  # Back section
                (0.25, 0.12), (0.4, 0.08),                 # Main straight
            ],
            
            # Template 6: Silverstone-style (fast and flowing)
            [
                (0.4, 0.1), (0.65, 0.12), (0.85, 0.2),    # Wellington straight
                (0.92, 0.35), (0.85, 0.5), (0.7, 0.45),   # Maggots/Becketts
                (0.6, 0.55), (0.7, 0.7), (0.6, 0.85),     # Hangar straight
                (0.4, 0.9), (0.2, 0.8), (0.12, 0.6),      # Stowe
                (0.2, 0.45), (0.15, 0.3), (0.25, 0.18),   # Club/Abbey
            ],
        ]
        
        # Pick a random template
        template = random.choice(templates)
        
        # Add randomization to the template
        points = []
        for tx, ty in template:
            # Add random variation (Â±10% of canvas)
            x = tx + random.uniform(-0.08, 0.08)
            y = ty + random.uniform(-0.08, 0.08)
            
            # Clamp to valid range
            x = max(0.1, min(0.9, x))
            y = max(0.1, min(0.9, y))
            
            # Scale to canvas
            px = self.margin + x * (self.canvas_width - 2 * self.margin)
            py = self.margin + y * (self.canvas_height - 2 * self.margin)
            
            points.append((px, py))
        
        # Optionally mirror horizontally or vertically for more variety
        if random.random() > 0.5:
            points = [(self.canvas_width - x, y) for x, y in points]
        if random.random() > 0.5:
            points = [(x, self.canvas_height - y) for x, y in points]
        
        # Optionally rotate
        if random.random() > 0.5:
            # Swap x and y (90 degree rotation)
            cx, cy = self.canvas_width / 2, self.canvas_height / 2
            points = [
                (cx + (y - cy) * 0.9, cy + (x - cx) * 0.9)  # Scale down slightly for aspect ratio
                for x, y in points
            ]
        
        return points
    
    def _catmull_rom_spline(self, points, samples_per_segment=4):
        """
        Generate smooth curve through points using Catmull-Rom spline.
        """
        if len(points) < 4:
            return points
        
        result = []
        n = len(points)
        
        for i in range(n):
            p0 = points[(i - 1) % n]
            p1 = points[i]
            p2 = points[(i + 1) % n]
            p3 = points[(i + 2) % n]
            
            for t_idx in range(samples_per_segment):
                t = t_idx / samples_per_segment
                
                # Catmull-Rom interpolation
                t2 = t * t
                t3 = t2 * t
                
                x = 0.5 * (
                    (2 * p1[0]) +
                    (-p0[0] + p2[0]) * t +
                    (2*p0[0] - 5*p1[0] + 4*p2[0] - p3[0]) * t2 +
                    (-p0[0] + 3*p1[0] - 3*p2[0] + p3[0]) * t3
                )
                
                y = 0.5 * (
                    (2 * p1[1]) +
                    (-p0[1] + p2[1]) * t +
                    (2*p0[1] - 5*p1[1] + 4*p2[1] - p3[1]) * t2 +
                    (-p0[1] + 3*p1[1] - 3*p2[1] + p3[1]) * t3
                )
                
                result.append((x, y))
        
        return result
    
    def _scale_to_canvas(self, waypoints):
        """Scale waypoints to fit within canvas with margin"""
        if not waypoints:
            return waypoints
        
        # Find bounds
        xs = [p[0] for p in waypoints]
        ys = [p[1] for p in waypoints]
        
        min_x, max_x = min(xs), max(xs)
        min_y, max_y = min(ys), max(ys)
        
        width = max_x - min_x
        height = max_y - min_y
        
        if width == 0 or height == 0:
            return waypoints
        
        # Calculate scale to fit with margin
        available_width = self.canvas_width - 2 * self.margin
        available_height = self.canvas_height - 2 * self.margin
        
        scale = min(available_width / width, available_height / height)
        
        # Scale and center
        scaled_width = width * scale
        scaled_height = height * scale
        
        offset_x = (self.canvas_width - scaled_width) / 2
        offset_y = (self.canvas_height - scaled_height) / 2
        
        result = []
        for x, y in waypoints:
            new_x = (x - min_x) * scale + offset_x
            new_y = (y - min_y) * scale + offset_y
            result.append((int(new_x), int(new_y)))
        
        return result
    
    def _is_too_oval(self, waypoints, threshold=0.85):
        """
        Check if track is too oval-like by comparing to best-fit ellipse.
        Returns True if track is too simple/oval.
        """
        if len(waypoints) < 10:
            return False
        
        # Calculate centroid
        cx = sum(p[0] for p in waypoints) / len(waypoints)
        cy = sum(p[1] for p in waypoints) / len(waypoints)
        
        # Calculate distances from centroid
        distances = [math.sqrt((p[0]-cx)**2 + (p[1]-cy)**2) for p in waypoints]
        
        # Calculate variance in distances
        mean_dist = sum(distances) / len(distances)
        variance = sum((d - mean_dist)**2 for d in distances) / len(distances)
        std_dev = math.sqrt(variance)
        
        # Coefficient of variation - low means oval-like
        cv = std_dev / mean_dist if mean_dist > 0 else 0
        
        # Also check for direction changes (ovals have smooth direction changes)
        # Use angle-based detection instead of cross product magnitude
        # (cross product magnitude depends on waypoint spacing)
        direction_changes = 0
        prev_sign = None
        for i in range(len(waypoints)):
            p0 = waypoints[(i - 1) % len(waypoints)]
            p1 = waypoints[i]
            p2 = waypoints[(i + 1) % len(waypoints)]
            
            # Vectors
            v1 = (p1[0] - p0[0], p1[1] - p0[1])
            v2 = (p2[0] - p1[0], p2[1] - p1[1])
            
            # Cross product sign indicates turn direction (left vs right)
            cross = v1[0] * v2[1] - v1[1] * v2[0]
            current_sign = 1 if cross > 0 else -1
            
            # Count when turn direction changes (left to right or vice versa)
            if prev_sign is not None and current_sign != prev_sign:
                direction_changes += 1
            prev_sign = current_sign
        
        # Track is too oval if:
        # - Low distance variance (circular shape)
        # - Few direction changes (ovals turn consistently in one direction)
        # A good track should have at least 2-3 direction changes (chicanes, S-curves)
        is_oval = cv < 0.15 and direction_changes < 2
        
        return is_oval
    
    def save(self, name, waypoints, output_dir="tools/tracks"):
        """
        Save track to JSON file.
        
        Args:
            name: Track name
            waypoints: List of (x, y) tuples
            output_dir: Output directory
        """
        os.makedirs(output_dir, exist_ok=True)
        
        # Clean name for filename
        safe_name = name.lower().replace(" ", "_").replace("-", "_")
        safe_name = "".join(c for c in safe_name if c.isalnum() or c == "_")
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"{safe_name}_{timestamp}.json"
        filepath = os.path.join(output_dir, filename)
        
        data = {
            "name": name,
            "waypoints": [list(p) for p in waypoints],
            "created": timestamp,
            "num_waypoints": len(waypoints),
            "generated_by": "track_generator",
        }
        
        with open(filepath, "w") as f:
            json.dump(data, f, indent=2)
        
        print(f"[OK] Saved: {filepath}")
        return filepath
    
    def export_python(self, name, waypoints):
        """
        Export waypoints as Python code for direct use in race/track.py
        """
        lines = [
            f'# Track: {name}',
            f'# Generated by track_generator.py',
            f'# Waypoints: {len(waypoints)}',
            '',
            'waypoints = [',
        ]
        
        # Format in rows of 5
        for i in range(0, len(waypoints), 5):
            row = waypoints[i:i+5]
            formatted = ", ".join([f"({p[0]}, {p[1]})" for p in row])
            lines.append(f"    {formatted},")
        
        lines.append(']')
        
        return "\n".join(lines)


# =============================================================================
# CLI INTERFACE
# =============================================================================

def main():
    """Command-line interface"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description="Generate F1-style race tracks",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python tools/track_generator.py --list
  python tools/track_generator.py --real bahrain
  python tools/track_generator.py --random --name "Custom Circuit"
  python tools/track_generator.py --random --complexity complex --seed 42
        """
    )
    
    parser.add_argument("--list", action="store_true", help="List available real tracks")
    parser.add_argument("--real", metavar="TRACK", help="Use a real F1 track")
    parser.add_argument("--random", action="store_true", help="Generate random track")
    parser.add_argument("--name", default="Generated Track", help="Track name")
    parser.add_argument("--complexity", choices=["simple", "medium", "complex"], 
                        default="medium", help="Random track complexity")
    parser.add_argument("--seed", type=int, help="Random seed for reproducibility")
    parser.add_argument("--export-python", action="store_true", 
                        help="Also export as Python code")
    
    parser.add_argument("--points", type=int, default=12, help="Number of control points")
    parser.add_argument("--chaos", type=float, default=0.5, help="Chaos factor (0.0-1.0)")
    parser.add_argument("--smooth", type=int, default=3, help="Smoothing passes")
    
    args = parser.parse_args()
    
    gen = TrackGenerator()
    
    if args.list:
        print("\n=== Available Real F1 Tracks ===\n")
        for track in gen.list_real_tracks():
            print(f"  {track['id']:12} - {track['name']} ({track['location']})")
        print()
        return
    
    if args.real:
        print(f"\n=== Loading Real Track: {args.real} ===\n")
        try:
            waypoints = gen.get_real_track(args.real)
            track_info = REAL_TRACKS[args.real.lower()]
            name = track_info["name"]
        except ValueError as e:
            print(f"[X] Error: {e}")
            return
    
    elif args.random:
        print(f"\n=== Generating Random Track ===\n")
        # Check if using legacy complexity or new fine-grained controls
        # If user specified points/chaos/smooth, use those.
        # Otherwise if they specified complexity, use that mapping.
        
        # For now, we'll just pass everything to generate_procedural if they didn't use complexity
        # But wait, generate_random maps complexity.
        
        if args.complexity != "medium" and args.points == 12:
             # User specified complexity but default points
             waypoints = gen.generate_random(args.complexity, args.seed)
        else:
             # Use the fine grained controls
             print(f"Points: {args.points}, Chaos: {args.chaos}, Smooth: {args.smooth}")
             if args.seed:
                 print(f"Seed: {args.seed}")
             waypoints = gen.generate_procedural(args.seed, args.points, args.chaos, args.smooth)
             
        name = args.name
    
    else:
        parser.print_help()
        return
    
    # Save track
    filepath = gen.save(name, waypoints)
    
    # Export Python if requested
    if args.export_python:
        python_code = gen.export_python(name, waypoints)
        py_filepath = filepath.replace(".json", ".py")
        with open(py_filepath, "w") as f:
            f.write(python_code)
        print(f"[OK] Python export: {py_filepath}")
    
    print(f"\nTrack: {name}")
    print(f"Waypoints: {len(waypoints)}")
    print()


if __name__ == "__main__":
    main()
