{
  "feature": "Race Commentary Highlights",
  "description": "Display text-based commentary for key race events like overtakes, pit stops, and fastest laps. Creates the feeling of watching an F1 broadcast with expert commentary highlighting important moments.",
  "created_at": "2026-01-08T05:21:19.716Z",
  "updated_at": "2026-01-08T23:23:03.187Z",
  "status": "in_progress",
  "planStatus": "approved",
  "phases": [
    {
      "id": "phase_1",
      "name": "Race Events Detection System",
      "description": "Create the core event detection system to track race events like overtakes, pit stops, and fastest laps",
      "subtasks": [
        {
          "id": "1.1",
          "title": "Create RaceEvent data class",
          "description": "Create a data class to represent race events with type, lap, time, involved drivers, and message",
          "status": "completed",
          "files": [
            "race/race_events.py"
          ],
          "acceptance_criteria": [
            "RaceEvent class with event_type, lap, timestamp, drivers, and message fields",
            "EventType enum for OVERTAKE, PIT_STOP, FASTEST_LAP, RACE_START, RACE_END, BLUE_FLAG"
          ],
          "notes": "Created RaceEvent data class with all required fields (event_type, lap, timestamp, drivers, message) and EventType enum with all event types (OVERTAKE, PIT_STOP, FASTEST_LAP, RACE_START, RACE_END, BLUE_FLAG). Implementation follows project patterns with proper docstrings and includes smart handling of single/multiple drivers.",
          "updated_at": "2026-01-08T23:26:56.268038+00:00"
        },
        {
          "id": "1.2",
          "title": "Create EventManager class",
          "description": "Create EventManager to collect, store, and provide access to race events with history limit",
          "status": "completed",
          "files": [
            "race/race_events.py"
          ],
          "acceptance_criteria": [
            "EventManager stores up to 50 recent events",
            "Methods: add_event(), get_recent_events(count), clear_events()",
            "Events sorted by timestamp (newest first for display)"
          ],
          "notes": "Created EventManager class with all required methods (add_event, get_recent_events, clear_events). Events are stored newest-first with configurable max_events limit (default 50). Includes __len__ and __repr__ for convenience. Implementation follows project patterns with proper docstrings and tested functionality.",
          "updated_at": "2026-01-08T23:28:40.772140+00:00"
        },
        {
          "id": "1.3",
          "title": "Add position tracking to Car class",
          "description": "Track previous position in Car class to detect overtakes between frames",
          "status": "completed",
          "files": [
            "race/car.py"
          ],
          "acceptance_criteria": [
            "Car.previous_position field tracks last frame position",
            "Car.position_changed() method returns True if position changed this frame"
          ],
          "notes": "Added previous_position field to Car class (initialized to starting_position) and position_changed() method that returns True when position differs from previous_position. This enables overtake detection between frames. Implementation follows existing code patterns with proper docstrings. Verified with test script.",
          "updated_at": "2026-01-08T23:30:56.188452+00:00"
        },
        {
          "id": "1.4",
          "title": "Integrate event detection into RaceEngine",
          "description": "Add event detection logic to RaceEngine.update() to detect overtakes, pit stops, fastest laps",
          "status": "completed",
          "files": [
            "race/race_engine.py"
          ],
          "acceptance_criteria": [
            "RaceEngine owns EventManager instance",
            "Detects overtakes by comparing position changes",
            "Detects pit stop start/end events",
            "Tracks and detects new fastest lap",
            "Generates RACE_START event when race begins"
          ],
          "notes": "Successfully integrated event detection into RaceEngine.update(). The system now:\n1. Owns an EventManager instance to track all race events\n2. Detects RACE_START event when race begins with iconic F1 \"Lights out and away we go!\" message\n3. Detects OVERTAKE events by comparing position changes between frames using the position_changed() method\n4. Detects PIT_STOP events for both entry (\"enters the pits\") and exit (\"exits the pits on {compound}s\")\n5. Tracks the overall fastest lap time and detects new FASTEST_LAP events with formatted time display (MM:SS.mmm)\n6. Updates previous_position after event detection to prepare for next frame's overtake detection\n\nAll events include lap number, timestamp, involved drivers list, and descriptive messages. Tested with simulation showing correct detection of race start and overtakes. Pit stops and fastest laps will be detected during full races.",
          "updated_at": "2026-01-08T23:33:44.308923+00:00"
        }
      ]
    },
    {
      "id": "phase_2",
      "name": "Commentary Generator",
      "description": "Create commentary text generation with authentic F1 terminology and varied phrases",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Create CommentaryGenerator class",
          "description": "Generator that converts race events into broadcast-style commentary text",
          "status": "completed",
          "files": [
            "race/commentary.py"
          ],
          "acceptance_criteria": [
            "CommentaryGenerator with generate_commentary(event) method",
            "Returns formatted string with F1 terminology",
            "Uses driver full names and team names appropriately"
          ],
          "notes": "Created CommentaryGenerator class with generate_commentary(event) method that converts race events into broadcast-style commentary. Supports all event types (RACE_START, OVERTAKE, PIT_STOP, FASTEST_LAP, RACE_END, BLUE_FLAG) with authentic F1 terminology. Uses driver full names from event.drivers list. Includes intelligent pit stop commentary that detects entry/exit and tire compound. Implementation follows project patterns with proper docstrings and tested with all event types.",
          "updated_at": "2026-01-08T23:36:28.092563+00:00"
        },
        {
          "id": "2.2",
          "title": "Add commentary templates for all event types",
          "description": "Create varied commentary templates for each event type with randomization",
          "status": "completed",
          "files": [
            "race/commentary.py"
          ],
          "acceptance_criteria": [
            "3-5 template variations per event type",
            "Templates for: overtakes, pit stops, fastest laps, race start/end",
            "Uses authentic F1 phrases (DRS, undercut, purple sector, etc.)"
          ],
          "notes": "Successfully added 3-6 varied commentary templates for each event type with authentic F1 terminology. Implemented:\n- RACE_START: 5 templates including iconic 'Lights out and away we go!'\n- OVERTAKE: 6 templates with DRS references and inside/outside moves\n- PIT_STOP: 5 entry templates (including 'Box, box, box') + 5 exit templates with tire compounds\n- FASTEST_LAP: 6 templates with 'purple sector' and 'blistering pace'\n- RACE_END: 5 templates with checkered flag references\n- BLUE_FLAG: 5 templates for lapped traffic scenarios\nAll methods use random.choice() to select from templates for variety. Tested and verified with all event types showing correct randomization and F1 terminology.",
          "updated_at": "2026-01-08T23:40:45.288867+00:00"
        }
      ]
    },
    {
      "id": "phase_3",
      "name": "Commentary Panel UI",
      "description": "Create the visual commentary panel that displays on the timing screen",
      "subtasks": [
        {
          "id": "3.1",
          "title": "Create CommentaryPanel UI component",
          "description": "Create a Pygame UI component that renders commentary messages in a scrollable panel",
          "status": "completed",
          "files": [
            "ui/commentary_panel.py"
          ],
          "acceptance_criteria": [
            "CommentaryPanel class with render(events) method",
            "Displays 3-5 most recent events",
            "Each event shows lap number and commentary text",
            "Team color coding for driver names",
            "Smooth scrolling when new events appear"
          ],
          "notes": "Created CommentaryPanel UI component with all required features:\n- CommentaryPanel class with render(event_manager) method that displays race commentary\n- Displays 3-5 most recent events (configurable via max_events_shown)\n- Each event shows lap number in a styled badge and commentary text\n- Team color coding for driver names using driver_to_team mapping and get_team_color()\n- Smooth scrolling animation with scroll_offset and lerp-based interpolation\n- Fade effect for older messages (newer events are brighter)\n- Word wrapping to fit within panel width\n- F1 broadcast-style dark theme matching TimingScreen design\n- Alternating row backgrounds for better readability\n- Integrates seamlessly with EventManager and CommentaryGenerator\n- Follows project patterns: separate surface, cached fonts, render method\n- Successfully tested with mock events showing proper rendering of all event types",
          "updated_at": "2026-01-08T23:44:26.421615+00:00"
        },
        {
          "id": "3.2",
          "title": "Style commentary panel to match F1 broadcast",
          "description": "Apply F1 broadcast-style visual design to the commentary panel",
          "status": "completed",
          "files": [
            "ui/commentary_panel.py"
          ],
          "acceptance_criteria": [
            "Dark background with subtle separation from timing",
            "Event type icons or color coding",
            "Lap number badge styling",
            "Fade effect for older messages"
          ],
          "notes": "Successfully applied F1 broadcast-style visual design to the commentary panel with all acceptance criteria met:\n\n\u2713 Dark background with subtle separation from timing - Enhanced header with darker background (30,30,30) and improved separator line\n\u2713 Event type icons or color coding - Implemented color-coded accent bars on the left of each event:\n  \u2022 Green (0,200,100) for RACE_START\n  \u2022 Orange (255,140,0) for OVERTAKE  \n  \u2022 Blue (100,150,255) for PIT_STOP\n  \u2022 Purple (200,50,200) for FASTEST_LAP (matching F1 purple sector)\n  \u2022 Light Blue (100,180,255) for BLUE_FLAG\n  \u2022 Gold (255,215,0) for RACE_END\n\u2713 Lap number badge styling - Enhanced badges with colored borders (2px) matching event type color, darker background, and colored lap text\n\u2713 Fade effect for older messages - Preserved existing fade implementation with clamped color values\n\nAdditional F1 broadcast enhancements:\n- F1 red accent line (3px) at top of panel header\n- Rounded corners (border_radius=3-4) for modern broadcast look\n- Better visual hierarchy with improved spacing\n- Safe color clamping in _apply_fade to prevent invalid RGB values\n\nTested with all event types showing correct color coding and styling.",
          "updated_at": "2026-01-08T23:49:52.190769+00:00"
        }
      ]
    },
    {
      "id": "phase_4",
      "name": "Integration and Polish",
      "description": "Integrate commentary system into the main game and add pause/scroll functionality",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Integrate CommentaryPanel into TimingScreen",
          "description": "Add commentary panel below the timing tower in the timing screen area",
          "status": "completed",
          "files": [
            "ui/timing_screen.py"
          ],
          "acceptance_criteria": [
            "Commentary panel renders below timing rows",
            "Panel gets events from RaceEngine.event_manager",
            "Layout fits within timing view width"
          ],
          "notes": "Successfully integrated CommentaryPanel into TimingScreen. The panel renders below the timing rows at y=650, displaying up to 3 recent race events with:\n- Imported CommentaryPanel into timing_screen.py\n- Initialized commentary panel in TimingScreen.__init__() with proper dimensions (600px width, 250px height)\n- Updated driver-team mapping on each render for proper color coding\n- Rendered commentary panel with events from race_engine.event_manager\n- Panel fits within timing view width and displays 3 events (space-optimized for 250px height)\n- All acceptance criteria met:\n  \u2713 Commentary panel renders below timing rows\n  \u2713 Panel gets events from RaceEngine.event_manager\n  \u2713 Layout fits within timing view width (600px)\n- Tested imports successfully, no syntax errors\n- Clean commit created",
          "updated_at": "2026-01-08T23:53:54.639459+00:00"
        },
        {
          "id": "4.2",
          "title": "Add commentary pause functionality",
          "description": "Allow user to pause commentary auto-scroll to review past events",
          "status": "completed",
          "files": [
            "ui/commentary_panel.py",
            "main.py"
          ],
          "acceptance_criteria": [
            "C key toggles commentary pause",
            "Visual indicator when commentary is paused",
            "Arrow keys scroll through paused commentary",
            "Auto-resume after period of inactivity"
          ],
          "notes": "Successfully implemented commentary pause functionality with all acceptance criteria met:\n\u2713 C key toggles commentary pause (main.py lines 316-318)\n\u2713 Visual indicator when paused - Orange accent bar and \"PAUSED (C to resume)\" text in header\n\u2713 Arrow keys (UP/DOWN) scroll through paused commentary (main.py lines 321-326)\n\u2713 Auto-resume after 5 seconds of inactivity (commentary_panel.py lines 112-115)\n\nImplementation details:\n- Added toggle_pause(), scroll_up(), and scroll_down() methods to CommentaryPanel\n- Pause state tracked with is_paused, manual_scroll_index, and last_interaction_time\n- Manual scrolling allows viewing up to 20 older events when paused\n- Auto-scroll resumes automatically after 5 seconds of no user interaction\n- Visual feedback: orange accent line replaces red, pause text shows in header\n- Keyboard controls integrated into main.py _handle_racing_event() method",
          "updated_at": "2026-01-08T23:56:33.067613+00:00"
        },
        {
          "id": "4.3",
          "title": "Add race end summary event",
          "description": "Generate summary commentary when race finishes",
          "status": "pending",
          "files": [
            "race/race_engine.py",
            "race/commentary.py"
          ],
          "acceptance_criteria": [
            "RACE_END event generated when leader finishes",
            "Commentary includes winner name and margin",
            "Commentary mentions any notable position changes"
          ]
        },
        {
          "id": "4.4",
          "title": "End-to-end testing and polish",
          "description": "Test complete commentary system and fix any issues",
          "status": "pending",
          "files": [],
          "acceptance_criteria": [
            "Commentary appears for all event types during race",
            "No duplicate or missed events",
            "Performance acceptable (no frame drops)",
            "All acceptance criteria from spec verified"
          ]
        }
      ]
    }
  ],
  "qa_status": {
    "status": "pending",
    "tests_passed": "",
    "issues": ""
  },
  "notes": "Commentary system follows existing patterns: separate race logic (race/) from UI (ui/). Events stored in RaceEngine, rendered by TimingScreen. Uses existing config.py colors and fonts.",
  "last_updated": "2026-01-08T23:56:33.067623+00:00"
}